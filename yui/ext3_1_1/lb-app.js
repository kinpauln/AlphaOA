Ext.ns("LBUI.app");LBUI.app.SearchField=Ext.extend(Ext.form.TwinTriggerField,{initComponent:function(){if(!this.store.baseParams){this.store.baseParams={}}LBUI.app.SearchField.superclass.initComponent.call(this);this.on("specialkey",function(a,b){if(b.getKey()==b.ENTER){this.onTrigger2Click()}},this)},validationEvent:false,validateOnBlur:false,trigger1Class:"x-form-clear-trigger",trigger2Class:"x-form-search-trigger",hideTrigger1:true,width:120,hasSearch:false,createClearParams:function(){return{start:0,Column:Ext.getCmp("search-type").getValue(),Search:1,key:""}},createQueryParams:function(a){return{start:0,Column:Ext.getCmp("search-type").getValue(),Search:1,key:a}},onTrigger1Click:function(){if(this.hasSearch){this.setValue("");var a=this.createClearParams();this.store.reload({params:a});this.triggers[0].hide();this.hasSearch=false;this.focus()}},onTrigger2Click:function(){var a=this.getRawValue();if(a.length<1){this.onTrigger1Click();return}var b=this.createQueryParams(a);this.store.reload({params:b});this.hasSearch=true;this.triggers[0].show();this.focus()}});LBUI.fun={cbxName:"checkbox",editStatus:"lb_edit_status",winf:"resizable=yes,status=no,scrollbars=yes,help=no,toolbar=no",getSelectId:function(){if(LBUI.getSelectId){return LBUI.getSelectId()}return null},onCmd:function(b){if(b.submit){this.onSubmit(b)}else{var c=this.getSelectId();if(b.select&&!(c)){LBUI.Ext.Msg.alert(b.text,"请先选择一条记录");return}var a=b.url;if(c){a+="&"+c}if(b.type!=null){a+="&WindowType="+b.type}if(Ext.isString(b.message)&&b.message.length>0){LBUI.Ext.Msg.confirm(b.text,b.message,function(d,e){if(d=="yes"){LBUI.fun.doCmd(b,a)}})}else{LBUI.fun.doCmd(b,a)}}},doCmd:function(d,b){if(d.popup){if(d.type!=null&&d.type==LBUI.CmdType.newWindow){window.open(Ext.urlEncode({extWindow:true,PopupWin:false,NewWindow:true,WindowType:d.type},b),"_blank",this.winf);return}if(d.type!=null&&(d.type==LBUI.CmdType.mainFrame||d.type==LBUI.CmdType.topWindow||d.type==LBUI.CmdType.parentWindow)){var e="_top";if(d.type==LBUI.CmdType.mainFrame){var c=window.self;while((c!=null&&c!=undefined)&&c!=c.parent){if(c.name=="fraRightFrame"){e="fraRightFrame";break}c=c.parent}}else{if(d.type==LBUI.CmdType.parentWindow){e="_parent"}}window.open(Ext.urlEncode({extWindow:true,PopupWin:false,WindowType:d.type},b),e);return}var a=this;LBUI.fun.checkStoreDirty({title:d.text,msg:"修改的数据未提交或保存,是否继续当前操作?",fn:function(){LBUI.showModalDialog(b,{fun:a})}})}else{document.location=Ext.urlEncode({extWindow:true},b)}},getCheckboxs:function(){var b=[];for(r=0;(r<LBUI.store.getCount());r++){var a=LBUI.store.getAt(r);if(a.get(this.cbxName)){b.push(a.get("id"))}}return b},isVerifyCheck:function(a){if(a.recType){return LBUI.RecordType.isVerifyCheck(a.recType)}return a.type!=LBUI.CmdType.noValidateCheck},isVerifyGridStatus:function(a){if(a.recType){return LBUI.RecordType.isVefiryEdit(a.recType)}return false},onSubmit:function(b){var a=[];if(this.isVerifyCheck(b)){a=this.getCheckboxs();if(a.length<=0){LBUI.Ext.Msg.alert(b.text,"请先在需要"+b.text+"的记录选择框打勾！");return}}if(Ext.isString(b.message)&&b.message.length>0){LBUI.Ext.Msg.confirm(b.text,b.message,function(c,d){if(c=="yes"){LBUI.fun.doSubmit(b,a)}})}else{LBUI.fun.doSubmit(b,a)}},doSubmit:function(d,c){var a=this;var b=function(){if(d.popup){LBUI.showModalDialog(d.url,{fun:a,submitData:c,submitName:a.cbxName});return}else{a.submit(d.url,d.text,c)}};if(this.isVerifyGridStatus(d)){LBUI.fun.checkStoreStatus({title:d.text,fn:b})}else{LBUI.fun.checkStoreDirty({title:d.text,msg:"修改的数据未提交或保存,是否继续当前操作?",fn:b})}},submit:function(b,d,c){var a=this;a.showWaiting();Ext.Ajax.request({url:b,method:"POST",params:{extResponse:true,isSubmit:1,checkbox:c},success:function(f,g){a.hideWaiting();var e=Ext.decode(f.responseText);if(e.retVal){if(e.message){LBUI.Tip.msg("",e.message)}if(Ext.isObject(e.data)&&!Ext.isEmpty(e.data.url)){if(e.data.submit){this.submit(e.data.url,"",this.getCheckboxs());return}if(e.data.redirect){showWaiting();document.location=e.data.url;return}}var i={};LBUI.store.reload({params:i})}else{var h=e.message||("执行"+d+"失败!");LBUI.Ext.MessageBox.alert(d,h)}},failure:function(){a.hideWaiting();LBUI.Ext.MessageBox.alert(d,"请求失败")}})},showWaiting:function(){LBUI.Ext.MessageBox.wait("系统正在处理中")},showMark:function(b){var a=new Ext.LoadMask(Ext.getBody(),{msg:b||"请稍候..."});a.show()},hideWaiting:function(){LBUI.Ext.MessageBox.updateProgress(1);LBUI.Ext.MessageBox.hide()},callback:function(a){if(a.retVal&&Ext.isObject(a.data)&&!Ext.isEmpty(a.data.url)){if(a.data.submit){if(!Ext.isEmpty(a.message)){LBUI.Tip.msg("",a.message)}this.submit(a.data.url,"",this.getCheckboxs());return}if(a.data.redirect){if(a.data.notWait!==true){this.showMark(a.message);if(!Ext.isEmpty(a.message)){setTimeout(function(){document.location=a.data.url},1000);return}}document.location=a.data.url;return}}if(!Ext.isEmpty(a.message)){var d=null;if(a.icon){d="icon:"+a.icon}if(a.retVal){LBUI.Tip.msg("",a.message,d)}else{LBUI.Tip.error("",a.message,d)}}if(a.retVal===LBUI.RefreshType.masterRefresh){try{var c={Refresh:true};LBUI.Master.LBUI.store.reload({params:c});return}catch(b){}}if(a.retVal){var c={};if(a.retVal===LBUI.RefreshType.clientRefresh){c.Refresh=true}LBUI.store.reload({params:c})}},changeUIMode:function(a){window.open(LBUI.config.url+"&UIMode="+a,LBUI.config.target)},refresh:function(){window.open(LBUI.config.url+"&Refresh=ALL",LBUI.config.target)},ajaxQuery:function(a){var b=Ext.getCmp(a).getForm();b.submit({params:{extResponse:true,loadStore:true},waitMsg:"查询中...",waitTitle:"请稍候",success:function(c,d){LBUI.store.loadData(d.result.data)},failure:function(c,d){if(d.failureType===Ext.form.Action.CONNECT_FAILURE){LBUI.Ext.Msg.alert("错误","连接服务器失败: "+d.response.statusText)}else{if(d.failureType===Ext.form.Action.SERVER_INVALID){LBUI.Ext.Msg.alert("错误",d.result.errormsg)}else{if(d.result){result=d.result;if(!Ext.isEmpty(result.message)){if(result.retVal){LBUI.Tip.msg("",result.message)}else{LBUI.Tip.error("",result.message)}}}}}}});return false},standQuery:function(a){var b=Ext.getCmp(a).getForm();if(b.isValid()){Ext.Msg.wait("系统正在查询中...","请稍候");return true}return false},query:function(a){if(LBUI.doQuery(a)){Ext.getDom(a).submit()}},isStoreDirty:function(){if(!LBUI.store||!LBUI.store.writer){return false}if(LBUI.store.modified&&LBUI.store.modified.length>0){return true}for(r=0;(r<LBUI.store.getCount());r++){var a=LBUI.store.getAt(r);var b=a.get(this.editStatus);if(b&&(b.dirty||b.create||b.error)){return true}}return false},checkStoreDirty:function(a){if(this.isStoreDirty()){LBUI.Ext.Msg.confirm(a.title,a.msg,function(b,c){if(b=="yes"){if(a.fn){a.fn()}}})}else{if(a.fn){a.fn()}}},isStoreCommitted:function(){if(!LBUI.store||!LBUI.store.writer){return true}if(LBUI.store.modified&&LBUI.store.modified.length>0){return false}if(LBUI.store.removed&&LBUI.store.removed.length>0){return false}return true},isStoreHasError:function(){if(!LBUI.store||!LBUI.store.writer){return false}for(r=0;(r<LBUI.store.getCount());r++){var a=LBUI.store.getAt(r);var b=a.get(this.editStatus);if(b&&b.error){return true}}return false},checkStoreStatus:function(d){var a=this;var c=function(){if(a.isStoreHasError()){LBUI.Ext.Msg.confirm(d.title,"表格中还有错误未修正,是否继续?",function(e,f){if(e=="yes"){if(d.fn){d.fn()}}})}else{if(d.fn){d.fn()}}};if(!this.isStoreCommitted()){LBUI.Ext.MessageBox.show({msg:d.waitMsg||"正在等待数据提交中",progressText:"",width:300,wait:true,waitConfig:{interval:200}});var b=Ext.TaskMgr.start({run:function(e){if(a.isStoreCommitted()){b.isNormalStop=true;Ext.TaskMgr.stop(b)}},interval:1000,duration:30000,onStop:function(){LBUI.Ext.MessageBox.hide();if(!b.isNormalStop){LBUI.Ext.Msg.confirm(d.title,"等待超时,是否继续?",function(e,f){if(e=="yes"){c()}})}else{c()}},scope:this})}else{c()}}};DoCommand=function(c,b,a,e,d){LBUI.fun.onCmd({url:c,select:b,popup:a,message:e,type:d})};window.onbeforeunload=function(a){if(LBUI.fun.isStoreDirty()){return"修改的数据未提交或保存,是否继续当前操作?"}};Ext.EventManager.on(document,"keydown",function(a){if(a.getKey()===a.BACKSPACE){var b=a.target;if((b===null)||(b.tagName!="INPUT"&&b.tagName!="TEXTAREA")||b.disabled||b.readOnly){a.stopEvent();return}}else{if(Ext.isIE&&LBUI.enterToTab===true){try{if(window.event.keyCode==13){if(event.srcElement.type=="file"){window.event.cancelBubble=true}else{if(event.srcElement.type!="button"&&event.srcElement.type!="submit"&&event.srcElement.type!="reset"&&event.srcElement.type!=""&&event.srcElement.type!="textarea"){window.event.keyCode=9}}}}catch(c){}}}});function fnViewAttachment(b,e,g){var h=new RegExp("^image/");var a=h.test(g);var c=null;if(a){var d=escape(b);c="/jsp/attachment/attachmentBody.jsp?Target="+d}else{c=b}var f="dialogHeight:"+screen.height+"px;dialogWidth:"+screen.width+"px";if(typeof(window)=="object"&&typeof(window.dialogHeight)!="undefined"&&typeof(window.dialogWidth)!="undefined"){window.showModalDialog(c,null,f)}else{if(e==null||typeof(e)=="undefined"||e==""){e="_blank"}window.open(c,e)}}function deleteAttach(c,b,e){if(typeof(e)!="string"||!confirm(e)){return}var d=document.forms[c];var a=d.action+"&EVENT_SOURCE=DeleteAttach&Column="+b;Ext.Ajax.request({url:a,params:{extResponse:true},success:function(f,i){var j=document.forms[c];var l=j[b];var h=l.parentNode;var k=0;var g=f.responseText;while(k++<=3&&h){if(h.tagName.toUpperCase()=="TABLE"){h.outerHTML=g}else{h=h.parentNode}}}})}function HandleGroupCaption(g){try{var h=Ext.get(g).next();var b=!h.isDisplayed();for(;h&&h.dom.className!=g.className;h=h.next()){h.setDisplayed(!h.isDisplayed())}var a=Ext.EventObject.getTarget();var i="/images/icon/collapse.gif";var d="/images/icon/expand.gif";if(b){a.src=d}else{a.src=i}if(LBUI.Events){LBUI.Events.fireEvent("groupExpand",g,b)}}catch(d){}}function HandleControlLabel(i){try{var j=Ext.get(i).next();var j=j.first();for(;j;j=j.next()){if(!j.isDisplayed()){var h="";var b=j.dom.originStyleDisplay;if(typeof(b==="string")){h=b}j.setDisplayed(h)}else{if(j.getStyle("display")!=undefined){j.dom.originStyleDisplay=j.getStyle("display")}j.setDisplayed("none")}}var g="/images/icon/dot.gif";var k="/images/icon/dotb.gif";var a=Ext.EventObject.getTarget();var d=a.expandState;if(!d){a.src=k;a.expandState=true}else{a.src=g;a.expandState=false}}catch(g){}}function HandleControlLabelUD(g){try{var h=Ext.get(g).next();var b=!h.isDisplayed();h.setDisplayed(!h.isDisplayed());var a=Ext.EventObject.getTarget();var d="/images/icon/dot.gif";var i="/images/icon/dotb.gif";if(b){a.src=d}else{a.src=i}}catch(d){}}LBUI.search={};LBUI.search.openCond=function(a){var b=LBUI.showModalDialog(a,{});b.fun=LBUI.fun;return b};LBUI.search.forwarddialog=function(b,a){document.location=a};LBUI.search.doManageAct=function(b,c){var a=b.parent.LBUI.config.url+"&operate=OnFormulaSearch&extResponse=true";a+=c;LBUI.search.forwarddialog(b,a)};LBUI.search.openCondManage=function(c,a){var b="";if(a!=null){b+="&conditionName="+a}b+="&goBack=true";LBUI.search.doManageAct(c,b)};LBUI.search.ConSel=Ext.extend(Ext.form.ComboBox,{mode:"local",loadingText:"搜索...",triggerAction:"all",valueField:"name",displayField:"desc",emptyText:"选择条件...",title:"请选择条件",editable:false,hideLabel:true,forceSelection:true});